# HW10 Deploy

## Описание

Я написал простое приложение на Flask, в котором есть один http хэндлер, который возвращает имя пода(из переменной окружения) и версию приложения. Собственно приложение до деплоя и после отличаются версией, возвращаемой этой ручкой (v1 до и v2 после). Исходные py-, docker-, yaml-файлы лежат в папках v1 и v2.
Для сбора метрик я написал еще одно фласк приложение, в котором поднял prometheus_client. У этого приложения два http хэндлера: один увеличивает значение метрики кол-ва запросов v1, а другой - запросов v2 (исходные py-, docker-, yaml-файлы лежат в папке metrics). И при вызове хэндлера основного приложения в зависимости от версии вызывался один из методов приложения для сбора метрик. Rate этих метрик я и показывал в видео-демонстрации.

### Recreate

Ссылка на видео https://drive.google.com/file/d/1qq85DCMlc5wjPuIOIuObaiKQrdE_OiIe/view?usp=sharing

На видео видно, что запросы v1 перестали приходить, а скрипт с нагрузкой остановился (не было активных подов, на которые можно было бы слать запросы). А после перезапуска скрипта все запросы уже были v2.

Файл deployment_recreate.yaml лежит в папке v2/recreate

### Rolling Update

Ссылка на видео https://drive.google.com/file/d/1tZTTMMagRPCtwd4cUUVxI-CFrv5U0ma5/view?usp=sharing

На видео видно, что в какой-то момент запросы шли в v1 и v2 вперемешку (какие-то поды уже успели перевыкатиться, а какие-то все еще оставались старой версии). Скрипт не прервался, потому что всегда были активные поды.

Файл deployment_rolling.yaml лежит в папке v2/rolling_update


### Blue-green

Для реализации данного способа деплоя я поднял рядом с работающим deployment такой же green-deployment с новой версией приложения. Таким образом весь трафик все еще шел в поды с приложением версии v1, но было поднято столько же подов с версией v2, на которые трафик еще не шел. Затем я переключил весь трафик на green-поды, обновив service/version-checker при помощи файла switch-to-green-service.yaml. В нем просто меняется selector: app: version-checker на green-version-checker. Убедившись, что v2 версия работает нормально, я удалил старый deployment и тем самым завершил процесс деплоя.

Ссылка на видео https://drive.google.com/file/d/1elHCKb3oNNCHx6rQu3gv_K39oQXVasjr/view?usp=sharing

